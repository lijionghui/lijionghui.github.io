<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://lijionghui.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'lijionghui'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lijionghui.github.io/"/>





  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/09/02/LRUCache原理/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/09/02/LRUCache原理/" itemprop="url">
                  LRUCache原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-02T11:28:26+08:00">
                2019-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/02/LRUCache原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/09/02/LRUCache原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="LRUCache基本介绍"><a href="#LRUCache基本介绍" class="headerlink" title="LRUCache基本介绍"></a>LRUCache基本介绍</h2><p>基本原理是把最近使用的对象存储在 LinkedHashMap 中，当缓存满时，把最近最少使用的对象从内存中移除，并提供了get和put方法来完成缓存的获取和添加操作。</p>
<h2 id="LRUCache基本使用"><a href="#LRUCache基本使用" class="headerlink" title="LRUCache基本使用"></a>LRUCache基本使用</h2><p>LRUCache在Android最常使用到的地方就是图片缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> maxMemory = (<span class="keyword">int</span>) (Runtime.getRuntime().totalMemory()/<span class="number">1024</span>);</div><div class="line"><span class="comment">//设置LruCache缓存的大小，一般为当前进程可用容量的1/8。</span></div><div class="line"><span class="keyword">int</span> cacheSize = maxMemory/<span class="number">8</span>;</div><div class="line"> mMemoryCache = <span class="keyword">new</span> LruCache&lt;String,Bitmap&gt;(cacheSize)&#123;</div><div class="line">  <span class="comment">//重写sizeOf方法，计算出要缓存的每张图片的大小。</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, Bitmap value)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> value.getRowBytes()*value.getHeight()/<span class="number">1024</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="LRUCache源码"><a href="#LRUCache源码" class="headerlink" title="LRUCache源码"></a>LRUCache源码</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mMemoryCache = <span class="keyword">new</span> LruCache&lt;String,Bitmap&gt;(cacheSize);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxSize &lt;= 0"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.maxSize = maxSize;</div><div class="line">        <span class="keyword">this</span>.map = <span class="keyword">new</span> LinkedHashMap&lt;K, V&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>可以看到初始化中使用了LinkedHashMap，且accessOrder为true说明LinkedHashMap中双向链表的结构是访问顺序，即把最新访问的放在队头。</p>
<h3 id="put"><a href="#put" class="headerlink" title="put()"></a>put()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null || value == null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        V previous;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="comment">//存储的计数加1</span></div><div class="line">            putCount++;</div><div class="line">            <span class="comment">//size 表示当期使用的缓存总大小 分析1</span></div><div class="line">            size += safeSizeOf(key, value);</div><div class="line">            <span class="comment">// 将新节点放入LinkedHashMap 如果有返回值，表示map集合中存在旧值</span></div><div class="line">            previous = map.put(key, value);</div><div class="line">            <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//如果有旧的值缓存大小还原</span></div><div class="line">                size -= safeSizeOf(key, previous);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//entryRemoved默认为空实现，根据需要自行实现</span></div><div class="line">        <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">            entryRemoved(<span class="keyword">false</span>, key, previous, value);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//整理每个节点 主要判断当前size是否超过maxSize  分析2</span></div><div class="line">        trimToSize(maxSize);</div><div class="line">        <span class="keyword">return</span> previous;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line"><span class="comment">//分析1 在这里会调用我们重写的sizeOf(key, value)方法，返回每个item的大小，默认返回1</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">safeSizeOf</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> result = sizeOf(key, value);</div><div class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Negative size: "</span> + key + <span class="string">"="</span> + value);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;    </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//分析2</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            K key;</div><div class="line">            V value;</div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (size &lt; <span class="number">0</span> || (map.isEmpty() &amp;&amp; size != <span class="number">0</span>)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(getClass().getName()</div><div class="line">                            + <span class="string">".sizeOf() is reporting inconsistent results!"</span>);</div><div class="line">                &#125;</div><div class="line">               <span class="comment">//如果缓存大小size小于最大缓存，不需要再删除缓存对象，跳出循环</span></div><div class="line">                <span class="keyword">if</span> (size &lt;= maxSize || map.isEmpty()) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//迭代器获取第一个对象，近期最少访问的元素</span></div><div class="line">                  找到并删除，更新缓存大小</div><div class="line">                Map.Entry&lt;K, V&gt; toEvict = map.entrySet().iterator().next();</div><div class="line">                key = toEvict.getKey();</div><div class="line">                value = toEvict.getValue();</div><div class="line">                map.remove(key);</div><div class="line">                size -= safeSizeOf(key, value);</div><div class="line">                evictionCount++;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            entryRemoved(<span class="keyword">true</span>, key, value, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在放入过程中，会先将缓存容量变大(变大的值为我们重写的sizeof方法，默认为1)，然后根据map中是否存在旧的值来确定是否还原到之前的缓存容量大小，然后调用trimToSize(maxSize)方法来确定是否到达缓存容量最大值，来删除最近最少使用的元素。</p>
<h3 id="get"><a href="#get" class="headerlink" title="get()"></a>get()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       V mapValue;</div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">       <span class="comment">//调用LinkedHashMap 的get方法 </span></div><div class="line">           mapValue = map.get(key);</div><div class="line">           <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">               hitCount++;</div><div class="line">               <span class="keyword">return</span> mapValue;</div><div class="line">           &#125;</div><div class="line">           missCount++;</div><div class="line">       &#125;</div><div class="line">      <span class="comment">//缓存没有情况下走创建流程 默认返回null</span></div><div class="line">       V createdValue = create(key);</div><div class="line">       <span class="keyword">if</span> (createdValue == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           createCount++;</div><div class="line">           mapValue = map.put(key, createdValue);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// There was a conflict so undo that last put</span></div><div class="line">               map.put(key, mapValue);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//为null的情况下增加容量大小</span></div><div class="line">               size += safeSizeOf(key, createdValue);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</div><div class="line">           entryRemoved(<span class="keyword">false</span>, key, createdValue, mapValue);</div><div class="line">           <span class="keyword">return</span> mapValue;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           trimToSize(maxSize);</div><div class="line">           <span class="keyword">return</span> createdValue;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在get()过程中就是判断是否之前在map()中存在，若存在换回存在的值；若不存在且createdValue为null直接返回null;若不存在且createdValue不为null即重写了createdValue()方法，则根据map是否有当前key来选择是否增加当前缓存容量大小。</p>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove()"></a>remove()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">remove</span><span class="params">(K key)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       V previous;</div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           previous = map.remove(key);</div><div class="line">           <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">               size -= safeSizeOf(key, previous);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">           entryRemoved(<span class="keyword">false</span>, key, previous, <span class="keyword">null</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> previous;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>remove方法很简单就是map如果已有就删除元素且更新缓存大小。<br>上面只是讲了缓存的管理，并没用说到底是如何做到最近最少使用的，这一快主要在LinkedHashMap中。</p>
<h2 id="LinkedHashMap相关"><a href="#LinkedHashMap相关" class="headerlink" title="LinkedHashMap相关"></a>LinkedHashMap相关</h2><h3 id="put（）"><a href="#put（）" class="headerlink" title="put（）"></a>put（）</h3><p>LinkedHashMap的put方法就是hashmap的put()方法,最后在put过程中会调用到afterNodeInsertion(),afterNodeAccess()方法这两个方法在LinkedHashMap中有重写这两个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; <span class="comment">// possibly remove eldest</span></div><div class="line">        LinkedHashMapEntry&lt;K,V&gt; first;</div><div class="line">        <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="keyword">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</div><div class="line">            K key = first.key;</div><div class="line">            removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// move node to last</span></div><div class="line">        LinkedHashMapEntry&lt;K,V&gt; last;</div><div class="line">        <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;</div><div class="line">            LinkedHashMapEntry&lt;K,V&gt; p =</div><div class="line">                (LinkedHashMapEntry&lt;K,V&gt;)e, b = p.before, a = p.after;</div><div class="line">            p.after = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (b == <span class="keyword">null</span>)</div><div class="line">                head = a;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                b.after = a;</div><div class="line">            <span class="keyword">if</span> (a != <span class="keyword">null</span>)</div><div class="line">                a.before = b;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                last = b;</div><div class="line">            <span class="keyword">if</span> (last == <span class="keyword">null</span>)</div><div class="line">                head = p;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                p.before = last;</div><div class="line">                last.after = p;</div><div class="line">            &#125;</div><div class="line">            tail = p;</div><div class="line">            ++modCount;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>jdk的人员已经给我注释好了方法，一个是移除，一个是把元素遇到最后，就是我们最近使用的地方。</p>
<h3 id="get-1"><a href="#get-1" class="headerlink" title="get()"></a>get()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">      Node&lt;K,V&gt; e;</div><div class="line">      <span class="keyword">if</span> ((e = getNode(hash(key), key)) == <span class="keyword">null</span>)</div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">if</span> (accessOrder)</div><div class="line">          afterNodeAccess(e);</div><div class="line">      <span class="keyword">return</span> e.value;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看到get()也会调用到afterNodeAccess(e),因此每次访问的时候回把元素放在最近使用的位置。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/08/30/线程池/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/08/30/线程池/" itemprop="url">
                  线程池使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-30T12:30:26+08:00">
                2019-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/30/线程池/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/08/30/线程池/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="线程池使用"><a href="#线程池使用" class="headerlink" title="线程池使用"></a>线程池使用</h2><p>利用线程池一方面可以解决大量创建线程池带来的性能问题，另一方面线程池方便管理线程，定时执行线程，间隔执行线程。</p>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p>ThreadPoolExecutor类是一个线程池实现的基本，1.8中构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> var1, <span class="keyword">int</span> var2, <span class="keyword">long</span> var3, TimeUnit var5, BlockingQueue&lt;Runnable&gt; var6, ThreadFactory var7, RejectedExecutionHandler var8)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(-<span class="number">536870912</span>, <span class="number">0</span>)); <span class="comment">//保证原子自增性</span></div><div class="line">        <span class="comment">//线程池的主要状态锁</span></div><div class="line">        <span class="keyword">this</span>.mainLock = <span class="keyword">new</span> ReentrantLock(); <span class="comment">//锁</span></div><div class="line">        <span class="comment">//用来存放工作集</span></div><div class="line">        <span class="keyword">this</span>.workers = <span class="keyword">new</span> HashSet(); </div><div class="line">        <span class="comment">//锁的条件</span></div><div class="line">        <span class="keyword">this</span>.termination = <span class="keyword">this</span>.mainLock.newCondition();</div><div class="line">        <span class="keyword">if</span> (var1 &gt;= <span class="number">0</span> &amp;&amp; var2 &gt; <span class="number">0</span> &amp;&amp; var2 &gt;= var1 &amp;&amp; var3 &gt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (var6 != <span class="keyword">null</span> &amp;&amp; var7 != <span class="keyword">null</span> &amp;&amp; var8 != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">this</span>.corePoolSize = var1;</div><div class="line">                <span class="keyword">this</span>.maximumPoolSize = var2;</div><div class="line">                <span class="keyword">this</span>.workQueue = var6;</div><div class="line">                <span class="keyword">this</span>.keepAliveTime = var5.toNanos(var3);</div><div class="line">                <span class="keyword">this</span>.threadFactory = var7;</div><div class="line">                <span class="keyword">this</span>.handler = var8;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>var1 = corePoolSize 核心线程数。</li>
<li>var2 = maximumPoolSize允许在线程池中的最大线程数量。</li>
<li>var6 = workQueue 存储将被execute方法执行的Runnable任务的队列。</li>
<li>TimeUnit var5 线程存活时间单位</li>
<li>keepAliveTime 非核心线程最长空闲时间，超过这个时间，空闲的非核心线程会被回收。通过var5.toNanos(var3)得到</li>
<li>threadFactory 线程工厂为线程池创建新线程的功能。</li>
<li>handler 任务拒绝策略，一般使用默认。</li>
</ol>
<p>上面是ThreadPoolExecutor的构造方法，但在开发过程中一般使用SingleThreadPool，FixedThreadPool，CachedThreadPool，ScheduledThreadPool这几个由Executors框架提供好的线程池，它们内部还是通过调用ThreadPoolExecutor的构造方法，只是为我们省去了一些过程。</p>
<h3 id="SingleThreadPool"><a href="#SingleThreadPool" class="headerlink" title="SingleThreadPool"></a>SingleThreadPool</h3><p>Executors.newSingleThreadExecutor();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Executors.FinalizableDelegatedExecutorService(<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue()));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从ThreadPoolExecutor的构造函数中我们可以看到，corePoolSize和maximumPoolSize都为1，说明这是一个只有一个核心线程数的线程池,下面用代码来证明一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ExecutorService executor = Executors.newSingleThreadExecutor();</div><div class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">20</span> ; i++)&#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> index = i;</div><div class="line">           executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   Log.d(<span class="string">"test"</span>, <span class="string">"任务 = "</span> + index + <span class="string">"，线程 = "</span> + Thread.currentThread().getName());</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       Thread.sleep(<span class="number">1000</span>);</div><div class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                       e.printStackTrace();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>返回的结果为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[DEBUG][test]任务 = <span class="number">0</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">1</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">2</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">3</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">......</div><div class="line">[DEBUG][test]任务 = <span class="number">17</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">18</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">19</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="FixedThreadPool"><a href="#FixedThreadPool" class="headerlink" title="FixedThreadPool"></a>FixedThreadPool</h3><p>创建方式Executors.newFixedThreadPool(3);<br>FixedThreadPool是可重用的固定线程数的线程池，创建方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> var0)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(var0, var0, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>从创建函数中我们可以看到，corePoolSize和maximumPoolSize都为var0，说明这是一个只有固定核心线程数的线程池,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"> ExecutorService executor = Executors.newFixedThreadPool(<span class="number">3</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">20</span> ; i++)&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = i;</div><div class="line">            executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    Log.d(<span class="string">"test"</span>, <span class="string">"任务 = "</span> + index + <span class="string">"，线程 = "</span> + Thread.currentThread().getName());</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">1000</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; </div><div class="line">        </div><div class="line">        </div><div class="line">[DEBUG][test]任务 = <span class="number">1</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">[DEBUG][test]任务 = <span class="number">0</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">2</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">[DEBUG][test]任务 = <span class="number">3</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">[DEBUG][test]任务 = <span class="number">4</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">5</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">[DEBUG][test]任务 = <span class="number">6</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">[DEBUG][test]任务 = <span class="number">7</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">8</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">[DEBUG][test]任务 = <span class="number">9</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">10</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">2</span></div></pre></td></tr></table></figure>
<h3 id="CachedThreadPool"><a href="#CachedThreadPool" class="headerlink" title="CachedThreadPool"></a>CachedThreadPool</h3><p>Executors.newCachedThreadPool()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, <span class="number">2147483647</span>, <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> SynchronousQueue());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>CachedThreadPool是只有非核心线程数且线程数为2147483647，keepAliveTime为60秒的线程池。将上面的测试代码改为Executors.newCachedThreadPool()<br>，返回结果为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[DEBUG][test]任务 = <span class="number">5</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">6</span></div><div class="line">[DEBUG][test]任务 = <span class="number">6</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">7</span></div><div class="line">[DEBUG][test]任务 = <span class="number">7</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">8</span></div><div class="line">[DEBUG][test]任务 = <span class="number">4</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">5</span></div><div class="line">[DEBUG][test]任务 = <span class="number">9</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">10</span></div><div class="line">[DEBUG][test]任务 = <span class="number">2</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">[DEBUG][test]任务 = <span class="number">3</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">4</span></div><div class="line">[DEBUG][test]任务 = <span class="number">1</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">[DEBUG][test]任务 = <span class="number">0</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">[DEBUG][test]任务 = <span class="number">8</span>，线程 = pool-<span class="number">1</span>-thread-<span class="number">9</span></div></pre></td></tr></table></figure>
<p>线程是在一直新建的。</p>
<h3 id="ScheduledThreadPool"><a href="#ScheduledThreadPool" class="headerlink" title="ScheduledThreadPool"></a>ScheduledThreadPool</h3><p>ScheduledThreadPool是一个能实现定时和周期性任务的线程池，创建方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> var0)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(var0);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(var1, <span class="number">2147483647</span>, <span class="number">0L</span>, TimeUnit.NANOSECONDS, <span class="keyword">new</span> ScheduledThreadPoolExecutor.DelayedWorkQueue());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> var1, <span class="keyword">int</span> var2, <span class="keyword">long</span> var3, TimeUnit var5, BlockingQueue&lt;Runnable&gt; var6)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(var1, var2, var3, var5, var6, Executors.defaultThreadFactory(), defaultHandler);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到最后还是调用了ThreadPoolExecutor的构造方法，使用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(<span class="number">3</span>);</div><div class="line"></div><div class="line">        Runnable task =<span class="keyword">new</span> Runnable()&#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">                System.out.println(<span class="string">"任务"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        scheduledThreadPool.schedule(task, <span class="number">1</span>, TimeUnit.SECONDS); <span class="comment">// 延迟1s后执行任务</span></div><div class="line">        scheduledThreadPool.shutdown();</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/08/29/EventBus解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/08/29/EventBus解析/" itemprop="url">
                  EventBus源码解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-29T11:17:26+08:00">
                2019-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/29/EventBus解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/08/29/EventBus解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="EventBus源码解析"><a href="#EventBus源码解析" class="headerlink" title="EventBus源码解析"></a>EventBus源码解析</h1><p>EventBus是一个优秀的第三方事件事件总线处理框架，具体的可以到这里 [<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">https://github.com/greenrobot/EventBus</a>] 查看。</p>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><hr>
<p>(1)定义事件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>(2)准备订阅者（指定主线程）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessageEvent</span><span class="params">(MessageEvent event)</span> </span>&#123;&#125;;</div></pre></td></tr></table></figure>
<p>(3)订阅者注册，解除注册 </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStart();</div><div class="line">    EventBus.getDefault().register(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStop();</div><div class="line">    EventBus.getDefault().unregister(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> (4)发送事件</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> MessageEvent());</div></pre></td></tr></table></figure>
<hr>
<h2 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h2><hr>
<ol>
<li>EventBus.getDefault()；//获取实例</li>
<li>EventBus.getDefault().register(this); //注册</li>
<li>EventBus.getDefault().unregister(this); //解注册</li>
<li>EventBus.getDefault().post(Object object); //发送普通事件</li>
<li>EventBus.getDefault().postSticky(Object object); //发送粘性事件</li>
</ol>
<hr>
<h3 id="EventBus-getDefault"><a href="#EventBus-getDefault" class="headerlink" title="EventBus.getDefault()"></a>EventBus.getDefault()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//使用双重检查锁模式获取单例</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">               <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                   defaultInstance = <span class="keyword">new</span> EventBus();<span class="number">1</span>.初始化</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> defaultInstance;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">分析<span class="number">1</span>：初始化</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(DEFAULT_BUILDER);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">  <span class="comment">//为EventBus里的各个变量赋值</span></div><div class="line">  EventBus(EventBusBuilder builder) &#123;</div><div class="line">       logger = builder.getLogger();  <span class="comment">//logger打印</span></div><div class="line">       subscriptionsByEventType = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">//以事件类型为key的map</span></div><div class="line">       typesBySubscriber = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">//以订阅者为key的map</span></div><div class="line">       stickyEvents = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); <span class="comment">//粘性事件的map</span></div><div class="line">       </div><div class="line">       <span class="comment">//主线程相关的初始化操作</span></div><div class="line">       mainThreadSupport = builder.getMainThreadSupport();</div><div class="line">       mainThreadPoster = mainThreadSupport != <span class="keyword">null</span> ? mainThreadSupport.createPoster(<span class="keyword">this</span>) : <span class="keyword">null</span>;</div><div class="line">       </div><div class="line">        <span class="comment">//后台线程相关的初始化操作</span></div><div class="line">       backgroundPoster = <span class="keyword">new</span> BackgroundPoster(<span class="keyword">this</span>);</div><div class="line">       </div><div class="line">       <span class="comment">//异步线程相关的初始化操作</span></div><div class="line">       asyncPoster = <span class="keyword">new</span> AsyncPoster(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">//得到订阅信息的数量</span></div><div class="line">       indexCount = builder.subscriberInfoIndexes != <span class="keyword">null</span> ? builder.subscriberInfoIndexes.size() : <span class="number">0</span>;</div><div class="line">       <span class="comment">//订阅方法查找类</span></div><div class="line">       subscriberMethodFinder = <span class="keyword">new</span> SubscriberMethodFinder(builder.subscriberInfoIndexes,</div><div class="line">               builder.strictMethodVerification, builder.ignoreGeneratedIndex);</div><div class="line">       logSubscriberExceptions = builder.logSubscriberExceptions;</div><div class="line">       logNoSubscriberMessages = builder.logNoSubscriberMessages;</div><div class="line">       <span class="comment">//订阅者发送事件异常</span></div><div class="line">       sendSubscriberExceptionEvent = builder.sendSubscriberExceptionEvent;</div><div class="line">       <span class="comment">//订阅者没有发送事件</span></div><div class="line">       sendNoSubscriberEvent = builder.sendNoSubscriberEvent;</div><div class="line">       <span class="comment">//异常</span></div><div class="line">       throwSubscriberException = builder.throwSubscriberException;</div><div class="line">       eventInheritance = builder.eventInheritance;</div><div class="line">       <span class="comment">//线程池</span></div><div class="line">       executorService = builder.executorService;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面完成了EventBus实例的基本配置</p>
<h3 id="EventBus-getDefault-register-this-注册"><a href="#EventBus-getDefault-register-this-注册" class="headerlink" title="EventBus.getDefault().register(this) 注册"></a>EventBus.getDefault().register(this) 注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">       Class&lt;?&gt; subscriberClass = subscriber.getClass();</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); <span class="comment">//1.查找订阅者中的所有订阅方法</span></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">               subscribe(subscriber, subscriberMethod); <span class="comment">//2.进行具体订阅操作</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"> <span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);  <span class="comment">//查找缓存如果缓存中有则直接返回</span></div><div class="line">       <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">           subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                   + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">//将查找到的结果放入缓存中            </span></div><div class="line">       METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>我们看下SubscriberMethod到底包含哪些东西</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SubscriberMethod</span><span class="params">(Method method, Class&lt;?&gt; eventType, ThreadMode threadMode, <span class="keyword">int</span> priority, <span class="keyword">boolean</span> sticky)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.method = method; <span class="comment">//方法</span></div><div class="line">    <span class="keyword">this</span>.threadMode = threadMode; <span class="comment">//线程</span></div><div class="line">    <span class="keyword">this</span>.eventType = eventType; <span class="comment">//事件类型</span></div><div class="line">    <span class="keyword">this</span>.priority = priority;  <span class="comment">//优先级</span></div><div class="line">    <span class="keyword">this</span>.sticky = sticky;  <span class="comment">//时候是粘性事件</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那是在哪里初始化的，是在SubscriberMethodFinder，AbstractSubscriberInfo中，这两个对应两种不同的查找方式，在上面我们发现EventBus会通过判断ignoreGeneratedIndex的值来调用不同的查找方法（1）findUsingReflection(subscriberClass);（2）findUsingInfo(subscriberClass)，ignoreGeneratedIndex的值可以通过EventBusBuilder来修改，默认情况下ignoreGeneratedIndex为false<br>，所以我们主要来分析一下findUsingInfo(subscriberClass)方法：</p>
<h4 id="findUsingInfo-subscriberClass"><a href="#findUsingInfo-subscriberClass" class="headerlink" title="findUsingInfo(subscriberClass)"></a>findUsingInfo(subscriberClass)</h4><p>首页看一下FindState这个类，它是SubscriberMethodFinder的内部类，主要包含订阅者和订阅方法信息变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FindState</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> Map&lt;Class, Object&gt; anyMethodByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> Map&lt;String, Class&gt; subscriberClassByMethodKey = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> StringBuilder methodKeyBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</div><div class="line"></div><div class="line">        Class&lt;?&gt; subscriberClass;</div><div class="line">        Class&lt;?&gt; clazz;</div><div class="line">        <span class="keyword">boolean</span> skipSuperClasses;</div><div class="line">        SubscriberInfo subscriberInfo;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       FindState findState = prepareFindState(); <span class="comment">//返回FindState对象</span></div><div class="line">       findState.initForSubscriber(subscriberClass);<span class="comment">//初始化一些订阅者信息</span></div><div class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123; <span class="comment">//进入循环</span></div><div class="line">           findState.subscriberInfo = getSubscriberInfo(findState);</div><div class="line">           <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123; <span class="comment">////获取订阅者信息，没有配置MyEventBusIndex返回null</span></div><div class="line">               SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</div><div class="line">               <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</div><div class="line">                   <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</div><div class="line">                       findState.subscriberMethods.add(subscriberMethod);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//通过反射查找订阅方法</span></div><div class="line">               findUsingReflectionInSingleClass(findState);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//进入父类查找订阅方法</span></div><div class="line">           findState.moveToSuperclass();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//获取方法并进行释放</span></div><div class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面代码首先会常见一个FindState类用来保存订阅者的方法和其他信息，然后通过循环查找当前类和分类的订阅方法，最后会返回所有获取到的方法并进行释放。一般情况下findState.subscriberInfo 都是为null,所以最后我们具体是通过反射findUsingReflectionInSingleClass(findState)来查找具体的方法。</p>
<h4 id="findUsingReflectionInSingleClass-findState"><a href="#findUsingReflectionInSingleClass-findState" class="headerlink" title="findUsingReflectionInSingleClass(findState)"></a>findUsingReflectionInSingleClass(findState)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">       Method[] methods;</div><div class="line">       <span class="comment">//通过反射拿到该订阅者的所有方法</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">           methods = findState.clazz.getDeclaredMethods();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">           <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></div><div class="line">           methods = findState.clazz.getMethods();</div><div class="line">           findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//遍历所有方法，取出符合条件的方法</span></div><div class="line">       <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">           <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">           <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 获得当前方法所有参数的类型</span></div><div class="line">               Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">               <span class="comment">//保证只有一个参数</span></div><div class="line">               <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">               <span class="comment">//找到用Subscribe注解的方法</span></div><div class="line">                   Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                   <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 得到该参数的类型</span></div><div class="line">                       Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                       </div><div class="line">                       <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                       <span class="comment">//得到线程</span></div><div class="line">                           ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                             <span class="comment">//实例化一个SubscriberMethod对象并添加到 findState.subscriberMethods中</span></div><div class="line">                           findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                   subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                   String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                           <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">               String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                       <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面代码中会先经过反射得到某个订阅者所有的方法，通过for循环找到EventBus注解的方法，再通过findState.checkAdd方法检验，最终会新建一个SubscriberMethod对象，并将该对象添加到findState.subscriberMethods的集合中，我们最终就能通过getMethodsAndRelease(findState)方法获取到所有订阅方法的集合。现在可以通过得到的subscriberMethods，进行真正的订阅。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// Must be called in synchronized block</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</div><div class="line">        <span class="comment">//获取到方法的事件类型</span></div><div class="line">        Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">         <span class="comment">//构造一个Subscription对象由订阅者和该订阅方法组成</span></div><div class="line">        Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</div><div class="line">        / subscriptionsByEventType是一个HashMap，保存了以eventType为key,Subscription对象集合为value的键值对</div><div class="line">        <span class="comment">// 先查找subscriptionsByEventType是否存在以当前eventType为key的值        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span></div><div class="line">        <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果不存在，则创建一个subscriptions，并保存到subscriptionsByEventType</span></div><div class="line">            subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></div><div class="line">                        + eventType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">             <span class="comment">// 添加上边创建的newSubscription对象到subscriptions中</span></div><div class="line">                subscriptions.add(i, newSubscription);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="comment">// typesBySubscriber也是一个HashMap，保存了以当前要注册类的对象为key，注册类中订阅事件的方法的参数类型的集合为value的键值对</span></div><div class="line">        <span class="comment">// 查找是否存在对应的参数类型集合</span></div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">        <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 不存在则创建一个subscribedEvents，并保存到typesBySubscriber</span></div><div class="line">            subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">        &#125;</div><div class="line">        /添加事件到 subscribedEvents集合中</div><div class="line">        subscribedEvents.add(eventType);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (subscriberMethod.sticky) &#123;<span class="comment">//如果是粘性事件</span></div><div class="line">            <span class="comment">// stickyEvents就是发送粘性事件时，保存了事件类型和对应事件</span></div><div class="line">            <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">                Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">                <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                    Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                    <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                        Object stickyEvent = entry.getValue();</div><div class="line">                        <span class="comment">// 处理粘性事件checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">                checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到这整个注册流程就梳理完了，这里总结一下：</p>
<ol>
<li>注册首先会通过SubscriberMethodFinder这个类来找到某个订阅者所有的订阅方法。</li>
<li>通过对得到的订阅方法遍历进行订阅。</li>
<li>订阅方法中用subscriptionsByEventType保存了以EventType为key,subscriptions为value的键值对。</li>
<li>typesBySubscriber保存以Subscriber为key，EventType集合为value的键值对</li>
<li>在有粘性事件的情况下会发送粘性消息进行处理</li>
</ol>
<h3 id="EventBus-getDefault-unregister-this-解注册"><a href="#EventBus-getDefault-unregister-this-解注册" class="headerlink" title="EventBus.getDefault().unregister(this); 解注册"></a>EventBus.getDefault().unregister(this); 解注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber); (<span class="number">1</span>)</div><div class="line">        <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;<span class="comment">//分析1</span></div><div class="line">                unsubscribeByEventType(subscriber, eventType);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 删除以subscriber为key的键值对            typesBySubscriber.remove(subscriber);</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.log(Level.WARNING, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//分析1 </span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">        List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">                Subscription subscription = subscriptions.get(i);</div><div class="line">                 <span class="comment">// 如果当前subscription对象对应的注册类对象和要取消注册的注册类对象相同，则删除当前subscription对象</span></div><div class="line">                <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</div><div class="line">                    subscription.active = <span class="keyword">false</span>;</div><div class="line">                    subscriptions.remove(i);</div><div class="line">                    i--;</div><div class="line">                    size--;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先在typesBySubscriber集合中查找除所有以当前subscriber为hey的subscribedTypes集合，对subscribedTypes进行遍历。</li>
<li>调用unsubscribeByEventType找到subscriptionsByEventType以某个eventType为key的subscriptions集合，对subscriptions集合遍历得到subscription对象，如果当前subscription对象对应的注册类对象和要取消注册的注册类对象相同，则删除当前subscription对象。</li>
<li>typesBySubscriber的集合中删除以该subscriber为key的键值对    </li>
</ol>
<h3 id="EventBus-getDefault-post-Object-object-发送普通事件"><a href="#EventBus-getDefault-post-Object-object-发送普通事件" class="headerlink" title="EventBus.getDefault().post(Object object); //发送普通事件"></a>EventBus.getDefault().post(Object object); //发送普通事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line"> </div><div class="line">  <span class="comment">//currentPostingThreadState是一个PostingThreadState类型的ThreadLocal</span></div><div class="line">       <span class="comment">// PostingThreadState类保存了事件队列和线程模式等信息</span></div><div class="line">        PostingThreadState postingState = currentPostingThreadState.get();</div><div class="line">        List&lt;Object&gt; eventQueue = postingState.eventQueue;</div><div class="line">         <span class="comment">// 将要发送的事件添加到事件队列</span></div><div class="line">        eventQueue.add(event);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!postingState.isPosting) &#123;</div><div class="line">            postingState.isMainThread = isMainThread();</div><div class="line">            postingState.isPosting = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (postingState.canceled) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123; <span class="comment">//队列不为空发送消息，并移除</span></div><div class="line">                    postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState); <span class="comment">//分析1</span></div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                postingState.isPosting = <span class="keyword">false</span>;</div><div class="line">                postingState.isMainThread = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"></div><div class="line"><span class="comment">//分析1 循环发送单个事件</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</div><div class="line">        Class&lt;?&gt; eventClass = event.getClass();</div><div class="line">        <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// eventInheritance默认为true，表示是否向上查找事件的父类</span></div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">            List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</div><div class="line">            <span class="keyword">int</span> countTypes = eventTypes.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</div><div class="line">                Class&lt;?&gt; clazz = eventTypes.get(h);</div><div class="line">                subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</div><div class="line">        &#125;</div><div class="line">         <span class="comment">//找不到事件异常处理</span></div><div class="line">        <span class="keyword">if</span> (!subscriptionFound) &#123;</div><div class="line">            <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</div><div class="line">                logger.log(Level.FINE, <span class="string">"No subscribers registered for event "</span> + eventClass);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</div><div class="line">                    eventClass != SubscriberExceptionEvent.class) &#123;</div><div class="line">                post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));<span class="comment">//发送没有订阅消息</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后会调用postSingleEventForEventType()方法进一步处理事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// 获取事件类型对应的Subscription集合</span></div><div class="line">            subscriptions = subscriptionsByEventType.get(eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</div><div class="line">        <span class="comment">//遍历subscriptions集合，给postingState.event赋值</span></div><div class="line">            <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</div><div class="line">                postingState.event = event;</div><div class="line">                postingState.subscription = subscription;</div><div class="line">                <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//真正的事件处理</span></div><div class="line">                    postToSubscription(subscription, event, postingState.isMainThread);</div><div class="line">                    aborted = postingState.canceled;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                 <span class="comment">//将postingState置为初始状态</span></div><div class="line">                    postingState.event = <span class="keyword">null</span>;</div><div class="line">                    postingState.subscription = <span class="keyword">null</span>;</div><div class="line">                    postingState.canceled = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (aborted) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到这里才看到最终真正处理事件的方法 postToSubscription(subscription, event, postingState.isMainThread);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">            <span class="keyword">case</span> POSTING: <span class="comment">// 默认的线程模式，在那个线程发送事件就在那个线程处理事件</span></div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MAIN: <span class="comment">//主线程</span></div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                  <span class="comment">// 如果在主线程发送事件，则直接在主线程通过反射处理事件</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果是在子线程发送事件，则将事件入队列，通过Handler切换到主线程执行处理事件</span></div><div class="line">                    mainThreadPoster.enqueue(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MAIN_ORDERED:</div><div class="line">                <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// 无论在那个线程发送事件，都先将事件入队列，然后通过 Handler 切换到主线程，依次处理事件。</span></div><div class="line">                    mainThreadPoster.enqueue(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BACKGROUND: </div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                 <span class="comment">// 如果在主线程发送事件，则先将事件入队列，然后通过线程池依次处理事件</span></div><div class="line">                    backgroundPoster.enqueue(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果在子线程发送事件，则直接在发送事件的线程通过反射处理事件</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ASYNC:  <span class="comment">// 无论在那个线程发送事件，都将事件入队列，然后通过线程池处理。</span></div><div class="line">                asyncPoster.enqueue(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在使用Subscribe注解的时候是可以指定线程的</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMessage</span><span class="params">(MessageEvent messageEvent)</span> </span>&#123;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>postToSubscription中的case条件就是threadMode指定的线程，根据不同的线程进行不同的处理。还记得EventBus.getDefault()的初始化方法吗，mainThreadPoster，backgroundPoster，asyncPoster就是在EventBus.getDefault()的赋值的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Poster</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">    AsyncPoster(EventBus eventBus) &#123;</div><div class="line">        <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">        queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">        queue.enqueue(pendingPost);</div><div class="line">        eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = queue.poll();</div><div class="line">        <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</div><div class="line">        &#125;</div><div class="line">        eventBus.invokeSubscriber(pendingPost);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到AsyncPoster通过enqueue方法，事件先入队，然后PendingPost pendingPost = queue.poll();的轮询获取 pendingPost，最后通过 eventBus.invokeSubscriber(pendingPost);其他两个poster最终也会调用eventBus.invokeSubscriber(pendingPost)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> </span>&#123;</div><div class="line">        Object event = pendingPost.event;</div><div class="line">        Subscription subscription = pendingPost.subscription;</div><div class="line">        PendingPost.releasePendingPost(pendingPost);</div><div class="line">        <span class="keyword">if</span> (subscription.active) &#123;</div><div class="line">            invokeSubscriber(subscription, event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>invokeSubscriber(pendingPost)最后还是调用了invokeSubscriber(subscription, event)方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</div><div class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">           handleSubscriberException(subscription, event, e.getCause());</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到最后是通过反射发送事件的。</p>
<h3 id="EventBus-getDefault-postSticky-Object-object-发送粘性事件"><a href="#EventBus-getDefault-postSticky-Object-object-发送粘性事件" class="headerlink" title="EventBus.getDefault(). postSticky(Object object); //发送粘性事件"></a>EventBus.getDefault(). postSticky(Object object); //发送粘性事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">     <span class="keyword">synchronized</span> (stickyEvents) &#123;</div><div class="line">         stickyEvents.put(event.getClass(), event);</div><div class="line">     &#125;</div><div class="line">     post(event);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>postSticky()方法主要做了两件事，先将事件类型和对应事件保存到stickyEvents中，方便在注册时如果是粘性事件则取出来直接发送处理；然后执行post(event)继续发送事件，这个post()方法就是之前发送普通消息的post()方法。所以，如果在发送粘性事件前，已经有了对应类型事件的订阅者，不是非粘性的，依然可以接收到发送出的粘性事件。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/08/28/ThreadLocal解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/08/28/ThreadLocal解析/" itemprop="url">
                  ThreadLocal解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-28T14:28:26+08:00">
                2019-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/28/ThreadLocal解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/08/28/ThreadLocal解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ThreadLocal解析"><a href="#ThreadLocal解析" class="headerlink" title="ThreadLocal解析"></a>ThreadLocal解析</h2><p>ThreadLocal用于保存某个线程共享变量,不同线程只能从中get，set，remove自己的变量，而不会影响其他线程的变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line"> threadLocal.set(<span class="string">"test"</span>);</div><div class="line"> threadLocal.get();</div><div class="line">```       </div><div class="line"></div><div class="line">看上面的代码是ThreadLocal的基本用法，初始化，设置，获取。</div><div class="line">看一下set方法：</div><div class="line"></div><div class="line">```<span class="function">java</span></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> &#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t); <span class="comment">//①获取ThreadLocalMap对象</span></div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">            map.set(<span class="keyword">this</span>, value); <span class="comment">//ThreadLocal变量作为key，local值作为value</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            createMap(t, value);<span class="comment">//②没有则创建 </span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="comment">//Thread内部变量</span></div><div class="line">ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</div><div class="line"><span class="comment">//分析①</span></div><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123; <span class="comment">//获取当前线程的ThreadLocalMap对象</span></div><div class="line">        <span class="keyword">return</span> t.threadLocals;</div><div class="line">&#125;  </div><div class="line"> </div><div class="line"><span class="comment">//分析② 创建一个新的ThreadLocalMap赋值给t.threadLocals</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">        t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到每个线程维护了一个ThreadLocal.ThreadLocalMap threadLocals变量，对threadLocal.set方法相当于用threadLocals把threadLocal作为key, threadLocal的值作为value保存起来。这样threadLocal的改变只对当前线程有用。</p>
<p>再来看看取值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                T result = (T)e.value;</div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> setInitialValue();①</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//分析①</span></div><div class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        T value = initialValue(); <span class="comment">//返回null</span></div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">            map.set(<span class="keyword">this</span>, value);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            createMap(t, value);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到取值也是先获取当前线程，然后当前线程的ThreadLocalMap，在ThreadLocalMap中查找是否有这个threadLocal的值，如果有就返回，没有就把当前threadLocal作为key，null作为值保存到ThreadLocalMap中，并返回nul值。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/08/25/handler解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/08/25/handler解析/" itemprop="url">
                  Handler解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-25T10:30:26+08:00">
                2019-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/25/handler解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/08/25/handler解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-Handler初始化"><a href="#一-Handler初始化" class="headerlink" title="一.Handler初始化"></a>一.Handler初始化</h2><p>在Android开发中Handler可以说是我们的常客，今天就来梳理一下Handler的原理。<br>分析一个类的源码可以从它的初始化方法和调用方法入手，下面先来看一下Handler的初始化方法，它的初始化方法很多但最终都会调用到下面这两个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback)</span> </span>&#123; ①不传Looper对象</div><div class="line">      <span class="keyword">this</span>(callback, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper, Callback callback)</span> </span>&#123; ②传Looper对象</div><div class="line">      <span class="keyword">this</span>(looper, callback, <span class="keyword">false</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们可以看到这两个方法的区别是Looper对象，在开始写Handler可能都遇到过 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.RuntimeException: Can<span class="string">'t create handler inside thread that has not called Looper.prepare()</span></div></pre></td></tr></table></figure>
<p>这个异常，这个异常的产生原因就是在子线程创建Handler的时候，没有手动调用 Looper.prepare()这个方法。那为什么在主线程初始化的时候不会报异常呢，这是因为在主线程中，系统已经默认帮我们实现了，那具体是什么呢，就是ActivityThread类。<br>ActivityThread类就是我们常说的主线程或UI线程，ActivityThread的main方法是整个APP的入口，这里我们主要展示Handler相关的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      </div><div class="line">       Looper.prepareMainLooper();</div><div class="line">     </div><div class="line">       ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">       thread.attach(<span class="keyword">false</span>, startSeq);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">           sMainThreadHandler = thread.getHandler();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">           Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                   LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">       &#125;</div><div class="line">      </div><div class="line">       Looper.loop();</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>接着我们看下 Looper.prepareMainLooper()这个方法，这里我们同时把Looper.prepare()的代码放进来一起对比一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">       prepare(<span class="keyword">false</span>);</div><div class="line">       <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">           <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</div><div class="line">           &#125;</div><div class="line">           sMainLooper = myLooper();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">       prepare(<span class="keyword">true</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p> 我们可以看到其实这两个方法最终都调用到了prepare(boolean)这个方法，</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">     &#125;</div><div class="line">     sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line"> &#125;</div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">     mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed); <span class="comment">//初始化MessageQueue</span></div><div class="line">     mThread = Thread.currentThread(); <span class="comment">//获取对应线程</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p> 又调用了Looper（boolean）为Looper里面的mQueue，mThread赋值，最后设置到 sThreadLocal里面。这里用到了ThreadLocal，它为每个使用该变量的线程提供独立的变量副本，所以每一个线程都可以独立地改变自己的副本，而不会影响其它线程所对应的副本。<br>还记得最开始的时候我们说过Handler的初始化最后都汇集到①②方法中，现在我们看一下①方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>.初始化</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">           <span class="keyword">final</span> Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">           <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                   (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</div><div class="line">               Log.w(TAG, <span class="string">"The following Handler class should be static or leaks might occur: "</span> +</div><div class="line">                   klass.getCanonicalName());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mLooper = Looper.myLooper();</div><div class="line">       <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">               <span class="string">"Can't create handler inside thread "</span> + Thread.currentThread()</div><div class="line">                       + <span class="string">" that has not called Looper.prepare()"</span>);</div><div class="line">       &#125;</div><div class="line">       mQueue = mLooper.mQueue;</div><div class="line">       mCallback = callback;</div><div class="line">       mAsynchronous = async;</div><div class="line">   &#125;</div><div class="line">   <span class="number">2</span>.获取looper</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>②方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper, Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">       mLooper = looper;</div><div class="line">       mQueue = looper.mQueue;</div><div class="line">       mCallback = callback;</div><div class="line">       mAsynchronous = async;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里我们看到了通过初始化Handler,Looper, MessageQueue三者建立起了连接，唯一的区别就是Looper的获取，一个是指定Looper,一个是从对应的sThreadLocal里获取。既然Handler,Looper, MessageQueue三者已经建立起了连接，现在我们就来说下发送消息。</p>
<h2 id="二-Handler消息发送"><a href="#二-Handler消息发送" class="headerlink" title="二.Handler消息发送"></a>二.Handler消息发送</h2><p>Handler发送消息的方法有多个，这里我们选取两个</p>
<h3 id="1-sendMessage-Message-msg"><a href="#1-sendMessage-Message-msg" class="headerlink" title="1.sendMessage(Message msg)"></a>1.sendMessage(Message msg)</h3><p><code>public final boolean sendMessage(Message msg)
    {
        return sendMessageDelayed(msg, 0);
    }</code></p>
<h3 id="2-post-Runnable-r"><a href="#2-post-Runnable-r" class="headerlink" title="2. post(Runnable r)"></a>2. post(Runnable r)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable r)</span></span></div><div class="line">   &#123;</div><div class="line">      <span class="keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">       Message m = Message.obtain();</div><div class="line">       m.callback = r;</div><div class="line">       <span class="keyword">return</span> m;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到两者最后都会调用sendMessageDelayed（Message msg, long delayMillis），而sendMessageDelayed又会调sendMessageAtTime（Message msg, long uptimeMillis）方法。区别在于post()方法这里会先把把Runnable对象转换成Message对象。下面看一下sendMessageAtTime（Message msg, long uptimeMillis）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">       MessageQueue queue = mQueue;</div><div class="line">       <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">           RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                   <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">           Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">       msg.target = <span class="keyword">this</span>;   <span class="comment">//handler对象</span></div><div class="line">       <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">           msg.setAsynchronous(<span class="keyword">true</span>); <span class="comment">//设置此消息是否为异步消息</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面msg.setAsynchronous(true)这个是用来设置消息是否为异步消息的，mAsynchronous是在Handler初始化时传入的，如果我们设置消息为异步消息时，可以通过MessageQueue类中的postSyncBarrier()设置同步屏障，那么队列中执行时间在这个Barrier以后的同步消息都会被这个Barrier拦截住无法执行，而异步消息则没有影响。通过调用removeSyncBarrier（int token）移除这个屏障，token为postSyncBarrier()的返回值。</p>
<h3 id="3-queue-enqueueMessage-msg-uptimeMillis-消息入队"><a href="#3-queue-enqueueMessage-msg-uptimeMillis-消息入队" class="headerlink" title="3. queue.enqueueMessage(msg, uptimeMillis) 消息入队"></a>3. queue.enqueueMessage(msg, uptimeMillis) 消息入队</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;  <span class="comment">//异步消息情况下为null</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (msg.isInUse()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">                IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">                        msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">                Log.w(TAG, e.getMessage(), e);</div><div class="line">                msg.recycle();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            msg.markInUse();</div><div class="line">            msg.when = when;</div><div class="line">            Message p = mMessages;</div><div class="line">            <span class="keyword">boolean</span> needWake;</div><div class="line">            <span class="comment">// 判断消息队列里有无消息</span></div><div class="line">           <span class="comment">// 若无，则将当前插入的消息 作为队头 &amp; 若此时消息队列处于等待状态，则唤醒</span></div><div class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">                <span class="comment">// New head, wake up the event queue if blocked.</span></div><div class="line">                msg.next = p;</div><div class="line">                mMessages = msg;</div><div class="line">                needWake = mBlocked;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 判断消息队列里有消息，则根据 消息（Message）创建的时间 插入到队列中</span></div><div class="line">                Message prev;</div><div class="line">                <span class="keyword">for</span> (;;) &#123;</div><div class="line">                    prev = p;</div><div class="line">                    p = p.next; </div><div class="line">                    <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123; </div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                        needWake = <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                msg.next = p; </div><div class="line">                prev.next = msg;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></div><div class="line">            <span class="keyword">if</span> (needWake) &#123;</div><div class="line">                nativeWake(mPtr);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>现在消息已经发送出去了，下面看看消息是如何分发接收的</p>
<h2 id="三-Handler消息分发接收"><a href="#三-Handler消息分发接收" class="headerlink" title="三.Handler消息分发接收"></a>三.Handler消息分发接收</h2><p>消息的分发接收主要是通过Looper.loop()方法，只贴出主要代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> Looper me = myLooper(); <span class="comment">//获取该线程的looper对象</span></div><div class="line">       <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> MessageQueue queue = me.mQueue;<span class="comment">//获取对应的MessageQueue对象</span></div><div class="line">        <span class="comment">// 消息循环（通过for循环）     </span></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="comment">//从消息队列中取出消息</span></div><div class="line">           Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">        <span class="comment">//发送消息到对应的Handler</span></div><div class="line">        msg.target.dispatchMessage(msg);</div><div class="line">      </div><div class="line">        <span class="comment">//回收资源  </span></div><div class="line">        msg.recycleUnchecked();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>看一下queue.next()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 该参数用于确定消息队列中是否还有消息</span></div><div class="line">       <span class="comment">// 从而决定消息队列应处于出队消息状态 or 等待状态</span></div><div class="line">       <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">               Binder.flushPendingCommands();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"></div><div class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">               <span class="comment">// Try to retrieve the next message.  Return if found.</span></div><div class="line">               <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">               Message prevMsg = <span class="keyword">null</span>;</div><div class="line">               Message msg = mMessages;</div><div class="line">              </div><div class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                       <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></div><div class="line">                       nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="comment">// 取消息</span></div><div class="line">                       mBlocked = <span class="keyword">false</span>;</div><div class="line">                       <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="comment">// prevMsg不空，说明有异步消息</span></div><div class="line">                           prevMsg.next = msg.next;</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           mMessages = msg.next;</div><div class="line">                       &#125;</div><div class="line">                       msg.next = <span class="keyword">null</span>;</div><div class="line">                       <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                       msg.markInUse();</div><div class="line">                       <span class="keyword">return</span> msg;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// No more messages.</span></div><div class="line">                   nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">               &#125;</div><div class="line">               </div><div class="line">           <span class="comment">// 消息队列空闲的时候，也就是有消息但是还没到时间，或者没有消息的时          候，会调用IdleHandler.queueIdle()</span></div><div class="line">           <span class="comment">// 可以通过 MessageQueue.addIdleHandler方法添加，可以用来做耗时较短的逻辑    </span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</div><div class="line">               <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</div><div class="line">               mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></div><div class="line"></div><div class="line">               <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   keep = idler.queueIdle();</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!keep) &#123;</div><div class="line">                   <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                       mIdleHandlers.remove(idler);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;      </div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里我们就取到了msg,然后通过msg.target.dispatchMessage(msg);发送</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;  <span class="comment">//若msg.callback属性不为空，则代表使用了post（Runnable r）发送消息</span></div><div class="line">    <span class="comment">//  ①则执行handleCallback(msg)，即回调Runnable对象里复写的run（）</span></div><div class="line">            handleCallback(msg);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123; <span class="comment">//初始化是传入的callback</span></div><div class="line">                <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//②在创建Handler实例时复写handleMessage方法</span></div><div class="line">            handleMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//①注释  </span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">     message.callback.run();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>上面我们讲到了异步消息，现在来着重分析一下</p>
<h2 id="四-Handler异步消息"><a href="#四-Handler异步消息" class="headerlink" title="四.Handler异步消息"></a>四.Handler异步消息</h2><p>首先异步消息的产生是在初始化是把async设置为true,但光是这样设置是没用的，得结合MessageQueue的postSyncBarrier()使用，不然异步消息就与同步消息没有区别。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">postSyncBarrier</span><span class="params">(<span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> token = mNextBarrierToken++;</div><div class="line">            <span class="comment">//1、屏障消息和普通消息的区别是屏障消息没有tartget。</span></div><div class="line">            <span class="keyword">final</span> Message msg = Message.obtain();</div><div class="line">            msg.markInUse();</div><div class="line">            msg.when = when;</div><div class="line">            msg.arg1 = token;</div><div class="line"></div><div class="line">            Message prev = <span class="keyword">null</span>;</div><div class="line">            Message p = mMessages;</div><div class="line">            <span class="comment">//2、根据时间顺序将屏障插入到消息链表中适当的位置</span></div><div class="line">            <span class="keyword">if</span> (when != <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">while</span> (p != <span class="keyword">null</span> &amp;&amp; p.when &lt;= when) &#123;</div><div class="line">                    prev = p;</div><div class="line">                    p = p.next;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123; <span class="comment">// invariant: p == prev.next</span></div><div class="line">                msg.next = p;</div><div class="line">                prev.next = msg;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                msg.next = p;</div><div class="line">                mMessages = msg;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//3、返回一个序号，通过这个序号可以撤销屏障</span></div><div class="line">            <span class="keyword">return</span> token;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>工作原理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 该参数用于确定消息队列中是否还有消息</span></div><div class="line">       <span class="comment">// 从而决定消息队列应处于出队消息状态 or 等待状态</span></div><div class="line">       <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">               Binder.flushPendingCommands();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"></div><div class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">               <span class="comment">// Try to retrieve the next message.  Return if found.</span></div><div class="line">               <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">               Message prevMsg = <span class="keyword">null</span>;</div><div class="line">               Message msg = mMessages;</div><div class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123; <span class="comment">//遇到屏障  msg.target == null</span></div><div class="line">                   <span class="keyword">do</span> &#123;</div><div class="line">                       prevMsg = msg;</div><div class="line">                       msg = msg.next;</div><div class="line">                   &#125; <span class="comment">//遍历消息链表找到最近的一条异步消息</span></div><div class="line">                   <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                      </div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="comment">// 取消息</span></div><div class="line">                       mBlocked = <span class="keyword">false</span>;</div><div class="line">                       <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="comment">// prevMsg不空，说明有异步消息</span></div><div class="line">                           prevMsg.next = msg.next;</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           mMessages = msg.next;</div><div class="line">                       &#125;</div><div class="line">                       msg.next = <span class="keyword">null</span>;</div><div class="line">                       <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                       msg.markInUse();</div><div class="line">                       <span class="keyword">return</span> msg;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// No more messages.</span></div><div class="line">                   nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">               &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://blog.csdn.net/start_mao/article/details/98963744" target="_blank" rel="external">https://blog.csdn.net/start_mao/article/details/98963744</a><br><a href="https://www.jianshu.com/p/b4d745c7ff7a" target="_blank" rel="external">https://www.jianshu.com/p/b4d745c7ff7a</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/04/05/从启动Activity方法中学习Kotlin/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/05/从启动Activity方法中学习Kotlin/" itemprop="url">
                  从启动Activity方法中学习Kotlin
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-05T22:30:26+08:00">
                2019-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kotlin/" itemprop="url" rel="index">
                    <span itemprop="name">kotlin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/05/从启动Activity方法中学习Kotlin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/04/05/从启动Activity方法中学习Kotlin/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近学习kotlin，想到kotlin在其他方法内部中如何启动Activity,查了一下是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">val intent = Intent(<span class="keyword">this</span><span class="meta">@SplashActivity</span>, MainActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></div><div class="line"><span class="title">startActivity</span>(<span class="title">intent</span>)</div></pre></td></tr></table></figure>
<p>这里用到了this表达式,kotlin中要访问来自外部作用域的this时，我们需要使用this@label，其中@label是一个代指this来源的标签，在上面就是代指来源自SplashActivity。<br>上面还用到了::符号MainActivity::class.java，其实相当于java中的MainActivity.getClass()。<br>有时为了方便我们会把启动Activity封装成一个方法，在kotlin中就有了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">inline fun &lt;reified T: Activity&gt; Activity.newIntent() &#123;</div><div class="line">    val intent = Intent(<span class="keyword">this</span>, T::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></div><div class="line">    <span class="title">startActivity</span>(<span class="title">intent</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法中用到了kotlin中的内联函数和扩展函数。下面分别来介绍一下。</p>
<h2 id="1-inline内联函数"><a href="#1-inline内联函数" class="headerlink" title="1. inline内联函数"></a>1. inline内联函数</h2><p>当一个简单的方法被调用时需要用到inline,因为调用一个方法是一个压栈和出栈的过程，调用方法时将栈帧压入方法栈，然后执行方法体，方法结束时将栈栈帧出栈，这个压栈和出栈的过程会耗费资源，这个过程中传递形参也会耗费资源。如以下这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fun &lt;T&gt; lock(lock: Lock, body: () -&gt; T): T &#123;</div><div class="line">        lock.lock()</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> body()</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock()</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们调用lock(l, {“lambda方法体”})，会将lock方法进行压栈和出栈操作，而当我们引入inline关键字时，此时再调用lock方法时，编译器会进行优化，相当于直接执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">lock.lock()</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">return</span> <span class="string">"lambda方法体"</span></div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          lock.unlock()</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>也就是说inline关键字实际上增加了代码量，但是提升了性能，而且增加的代码量是在编译期执行的，对程序可读性不会造成影响。</p>
<h2 id="2-reified具体化的类型参数"><a href="#2-reified具体化的类型参数" class="headerlink" title="2. reified具体化的类型参数"></a>2. reified具体化的类型参数</h2><p>官方说明是这样的<br>有时候我们需要访问一个作为参数传给我们的一个类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fun &lt;T&gt; TreeNode.findParentOfType(clazz: Class&lt;T&gt;): T? &#123;</div><div class="line">    var p = <span class="function">parent</span></div><div class="line">    <span class="title">while</span> <span class="params">(p != <span class="keyword">null</span> &amp;&amp; !clazz.isInstance(p)</span>) &#123;</div><div class="line">        p = p.parent</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Suppress</span>(<span class="string">"UNCHECKED_CAST"</span>)</div><div class="line">    <span class="keyword">return</span> p as T?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里我们向上遍历一棵树并且检查每个节点是不是特定的类型。 这都没有问题，但是调用处不是很优雅：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">treeNode.findParentOfType(MyTreeNode::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></div></pre></td></tr></table></figure>
<p>我们真正想要的只是传一个类型给该函数，即像这样调用它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">treeNode.findParentOfType&lt;MyTreeNode&gt;()</div></pre></td></tr></table></figure>
<p>为能够这么做，内联函数支持具体化的类型参数，于是我们可以这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">inline fun &lt;reified T&gt; TreeNode.findParentOfType(): T? &#123;</div><div class="line">    var p = <span class="function">parent</span></div><div class="line">    <span class="title">while</span> <span class="params">(p != <span class="keyword">null</span> &amp;&amp; p !is T)</span> &#123;</div><div class="line">        p = p.parent</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> p as T?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用 reified 修饰符来限定类型参数，现在可以在函数内部访问它了， 几乎就像是一个普通的类一样。由于函数是内联的，不需要反射，正常的操作符如 !is 和 as 现在都能用了。此外，我们还可以按照上面提到的方式调用它：myTree.findParentOfType<mytreenodetype>()。<br>对比我们的Activity,总的来说就是用了reified后，就能在方法内直接使用传入的Activity具体类型。</mytreenodetype></p>
<h2 id="3-kotlin扩展函数"><a href="#3-kotlin扩展函数" class="headerlink" title="3. kotlin扩展函数"></a>3. kotlin扩展函数</h2><p>声明一个扩展函数，我们需要用一个接收者类型也就是被扩展的类型来作为他的前缀。下面代码为MutableList<int>添加一个swap 函数：</int></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">fun MutableList&lt;Int&gt;.swap(index1: Int, index2: Int) &#123;</div><div class="line">    val tmp = <span class="keyword">this</span>[index1] <span class="comment">// “this”对应该列表</span></div><div class="line">    <span class="keyword">this</span>[index1] = <span class="keyword">this</span>[index2]</div><div class="line">    <span class="keyword">this</span>[index2] = tmp</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个this关键字在扩展函数内部对应到接收者对象（传过来的在点符号前的对象）现在，我们对任意 MutableList<int> 调用该函数了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">val l = mutableListOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</div><div class="line">l.swap(<span class="number">0</span>, <span class="number">2</span>) <span class="comment">// “swap()”内部的“this”得到“l”的值</span></div></pre></td></tr></table></figure></int></p>
<p>对于我们的Activity启动</p>
<pre><code class="java">inline fun &lt;reified T: Activity&gt; Activity.newIntent() {
    val intent = Intent(<span class="keyword">this</span>, T::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)
    <span class="title">startActivity</span>(<span class="title">intent</span>)
}</span>
</code></pre>
<p>其实相当于对Activity类型添加一个newIntent()方法，使得任意Activity可以调用这个方法。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/03/13/Mac下使用sublime导入源代码/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/13/Mac下使用sublime导入源代码/" itemprop="url">
                  Mac下使用sublime导入源代码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-13T13:24:16+08:00">
                2019-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/13/Mac下使用sublime导入源代码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/03/13/Mac下使用sublime导入源代码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Mac下使用sublime导入Android源代码"><a href="#Mac下使用sublime导入Android源代码" class="headerlink" title="Mac下使用sublime导入Android源代码"></a>Mac下使用sublime导入Android源代码</h1><h2 id="1-下载源代码"><a href="#1-下载源代码" class="headerlink" title="1.下载源代码"></a>1.下载源代码</h2><p>  到（<a href="https://github.com/android/platform_frameworks_base）去下载一份源码。" target="_blank" rel="external">https://github.com/android/platform_frameworks_base）去下载一份源码。</a></p>
<h2 id="2-下载配置sublime"><a href="#2-下载配置sublime" class="headerlink" title="2.下载配置sublime"></a>2.下载配置sublime</h2><p>  选择sublime菜单栏的File -&gt; Open 选择源码解压后的根目录，打开，然后就可以看到Android源码的列表在左侧展示了。     </p>
<h2 id="3-使用Ctags代码跳转插件"><a href="#3-使用Ctags代码跳转插件" class="headerlink" title="3.使用Ctags代码跳转插件"></a>3.使用Ctags代码跳转插件</h2><p>  1.左上角Sublime Text 2 -&gt; Preference -&gt; Browse Packages 查看是否已经安装了CTags Package，如果没有则需要安装<br>  2.Sublime Text 2 -&gt; Preference -&gt; Package Control, 输入Install Package，在列表中输入选择 Ctags 插件进行安装<br>  3.修改函数跳转方式：Perference -&gt; Package Settings-&gt;CTags-&gt;Mouse Binding Default-&gt;复制全部-&gt;粘贴到Mouse Binding User<br>把里面的”ctrl+shift”，修改为“command”，<pre><code>[<br>    {<br>        “button”: “button1”,<br>        “count”: 1,<br>        “press_command”: “drag_select”,<br>        “modifiers”: [“command”],<br>        “command”: “navigate_to_definition”<br>    },<br>    {<br>        “button”: “button2”,<br>        “count”: 1,<br>        “modifiers”: [“command”],<br>        “command”: “jump_prev”<br>    }<br>]</code></pre><br>这样就可以用“command+左键”跳转了<br>  4.右键点击侧边栏中Android 源码根目录，右键-&gt; CTags: Rebuild Tags   </p>
<p>##4.安装Ctags是遇到的问题<br>  在右键-&gt; CTags: Rebuild Tags中如果出现警告</p>
<p><pre><code>ctags: illegal option – R<br>usage: ctags [-BFadtuwvx] [-f tagsfile] file …。<br></code></pre>那么说明你用的Ctags是系统预安装的版本，命令行输入which ctags,如果输出/usr/bin/ctags，就说明这个时候需要我们自己下载一个可用的Ctags。<br>  命令行输入brew install ctags 进行安装。或者直接用这个链接下载 <a href="http://downloads.sourceforge.net/ctags/ctags-5.8.tar.gz" target="_blank" rel="external">http://downloads.sourceforge.net/ctags/ctags-5.8.tar.gz</a><br>  使用brew安装是可能出现ruby版本不符的问题，<pre><code>Homebrew must be run under Ruby 2.3!</code></pre>这时需要将ruby升级，在命令行输入<pre><code> brew install ruby@2.3 </code></pre>如果升级过程中出现<pre><code> Error: Xcode alone is not sufficient on Sierra.Install the Command Line Tools:xcode-select –install  </code></pre>需要输入命令<pre><code>xcode-select –install</code></pre>安装CommandLineTools。<br>  问题都解决后再重新安装ctags。<br>  安装完成后在usr/local/bin/ 目录下可以看到安装完成的ctags。<br>  接下来我们在终端 中用cd命令跳转到源码的根目录 ，执行/usr/local/bin/ctags -R -f .tags ，等待片刻，目录下会生成一个.tags的文件。<br>  接下来可以点击源码中的方法或者类进行跳转了。
  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2018/06/13/无法覆盖安装的问题/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/13/无法覆盖安装的问题/" itemprop="url">
                  Android apk无法覆盖安装的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-13T09:37:26+08:00">
                2018-06-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/13/无法覆盖安装的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/13/无法覆盖安装的问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有时开发过程中需要在手机上安装不同版本的apk,这里的不同版本指的是Android下面的多渠道打包，通过给productFlavors，buildTypes设置不同的applicationId。具体设置方法参考(<a href="https://developer.android.google.cn/studio/build/application-id" target="_blank" rel="external">https://developer.android.google.cn/studio/build/application-id</a>)<br>这里主要讲下遇到的问题，因为在项目中使用了provider，通过查询资料得到原来不同apk的内容提供器provider使用了同样的授权，这时即使包名不同，也无法覆盖安装。解决问题让不同的apk使用不同的provider授权。具体操作为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;provider  </div><div class="line">          android:authorities="&#123;applicationId&#125;.provider"  </div><div class="line">          android:enabled=["true" | "false"]  </div><div class="line">          android:exported=["true" | "false"]  </div><div class="line">          android:grantUriPermissions=["true" | "false"]  </div><div class="line">         &gt;  </div><div class="line">    . . .  </div><div class="line">&lt;/provider&gt;</div></pre></td></tr></table></figure>
<p>将authorities的值用{applicationId}.provider代替，因为多渠道下设置不同applicationId，得到的authorities是不同的，可以在打包后用AndroidStudio中的Analyze Apk工具查看AndroidManifest.xml,对应修改provider。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2018/06/11/老项目升级到AndroidStudio遇到的问题/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/11/老项目升级到AndroidStudio遇到的问题/" itemprop="url">
                  老项目升级到AndroidStudio3.0遇到的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-11T20:57:53+08:00">
                2018-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/11/老项目升级到AndroidStudio遇到的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/11/老项目升级到AndroidStudio遇到的问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.apt问题解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>.在project的build.gradle中删除</div><div class="line">classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line"><span class="number">2</span>.在<span class="keyword">module</span>的build.gradle中删除</div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"><span class="number">3</span>.将build.gradle文件中的dependency的apt改成annotationProcessor如</div><div class="line">apt  <span class="string">'com.jakewharton:butterknife-compiler:8.1.0'</span></div><div class="line"><span class="comment">//改为</span></div><div class="line">annotationProcessor  <span class="string">'com.jakewharton:butterknife-compiler:8.1.0'</span></div></pre></td></tr></table></figure>
<p>2.All flavors must now belong to a named flavor dimension<br>这个问题官网是这样解释的：要解决此错误，请将每个风味分配至一个给定维度，如下面的示例中所示。由于依赖项匹配现在由插件处理，您应当谨慎地为风味维度命名。例如，如果您的所有应用和库模块均使用 foo 维度，您对插件可以匹配的风味的控制力较弱。官网上解决方案如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// In the app's build.gradle file.</span></div><div class="line">android &#123;</div><div class="line">    defaultConfig&#123;</div><div class="line">    <span class="comment">// Do not configure matchingFallbacks in the defaultConfig block.</span></div><div class="line">    <span class="comment">// Instead, you must specify fallbacks for a given product flavor in the</span></div><div class="line">    <span class="comment">// productFlavors block, as shown below.</span></div><div class="line">  &#125;</div><div class="line">    flavorDimensions <span class="string">'tier'</span></div><div class="line">    productFlavors &#123;</div><div class="line">        paid &#123;</div><div class="line">            dimension <span class="string">'tier'</span></div><div class="line">            <span class="comment">// Because the dependency already includes a "paid" flavor in its</span></div><div class="line">            <span class="comment">// "tier" dimension, you don't need to provide a list of fallbacks</span></div><div class="line">            <span class="comment">// for the "paid" flavor.</span></div><div class="line">        &#125;</div><div class="line">        free &#123;</div><div class="line">            dimension <span class="string">'tier'</span></div><div class="line">            <span class="comment">// Specifies a sorted list of fallback flavors that the plugin</span></div><div class="line">            <span class="comment">// should try to use when a dependency's matching dimension does</span></div><div class="line">            <span class="comment">// not include a "free" flavor. You may specify as many</span></div><div class="line">            <span class="comment">// fallbacks as you like, and the plugin selects the first flavor</span></div><div class="line">            <span class="comment">// that's available in the dependency's "tier" dimension.</span></div><div class="line">            matchingFallbacks = [<span class="string">'demo'</span>, <span class="string">'trial'</span>]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是在android中加入一行flavorDimensions ‘tier’,在productFlavors中对应加入dimension ‘tier’,具体可查看（<a href="https://developer.android.google.cn/studio/build/gradle-plugin-3-0-0-migration）" target="_blank" rel="external">https://developer.android.google.cn/studio/build/gradle-plugin-3-0-0-migration）</a></p>
<p>3.遇到类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Error:Could not resolve all dependencies <span class="keyword">for</span> configuration</div><div class="line">  <span class="string">':app:prodDebugCompileClasspath'</span>.</div><div class="line">Project :app declares a dependency from configuration <span class="string">'compile'</span></div><div class="line">  to configuration <span class="string">'debug'</span> which is not declared in the descriptor</div><div class="line">  <span class="keyword">for</span> project :foo.</div></pre></td></tr></table></figure>
<p>的问题，也可以通过（<a href="https://developer.android.google.cn/studio/build/gradle-plugin-3-0-0-migration）自己查看。" target="_blank" rel="external">https://developer.android.google.cn/studio/build/gradle-plugin-3-0-0-migration）自己查看。</a><br>这里贴一下官方给出的方法，您应当按如下方式配置您的依赖项：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    <span class="comment">// This is the old method and no longer works for local</span></div><div class="line">    <span class="comment">// library modules:</span></div><div class="line">    <span class="comment">// debugCompile project(path: ':foo', configuration: 'debug')</span></div><div class="line">    <span class="comment">// releaseCompile project(path: ':foo', configuration: 'release')</span></div><div class="line"></div><div class="line">    <span class="comment">// Instead, simply use the following to take advantage of</span></div><div class="line">    <span class="comment">// variant-aware dependency resolution. You can learn more about</span></div><div class="line">    <span class="comment">// the 'implementation' configuration in the section about</span></div><div class="line">    <span class="comment">// new dependency configurations.</span></div><div class="line">    <span class="function">implementation <span class="title">project</span><span class="params">(<span class="string">':foo'</span>)</span></span></div><div class="line"></div><div class="line">    <span class="comment">// You can, however, keep using variant-specific configurations when</span></div><div class="line">    <span class="comment">// targeting external dependencies. The following line adds 'app-magic'</span></div><div class="line">    <span class="comment">// as a dependency to only the 'debug' version of your module.</span></div><div class="line"></div><div class="line">    debugImplementation 'com.example.android:app-magic:12.3'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注：您无法再为手动变体依赖项轻松使用旧机制，即使相关的 Gradle API 仍然存在。 向 project() DSL 提供的配置现在需要匹配构建类型和风味中的消费者（和其他属性）。 例如，无法通过这种机制让“调试”变体成为“发布”变体，因为生产者和消费者将不匹配。 （在这种情况下，名称“调试”是指在下文发布依赖项部分中提到的已发布配置对象。） 请注意，我们会发布两种配置，一种用于编译，一种用于运行时，这种比较旧的配置选择方式已经不再适用。简单点就是把原来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// debugCompile project(path: ':foo', configuration: 'debug')</span></div><div class="line"><span class="comment">// releaseCompile project(path: ':foo', configuration: 'release')</span></div></pre></td></tr></table></figure>
<p>我们手动配置的依赖使用implementation project。因为现在gradle会自动帮我们去匹配。</p>
<p>4.Gradle sync failed: Cause: org/gradle/listener/ActionBroadcast<br>老项目使用plugins {<br>    id “org.sonarqube” version “2.2”<br>}<br>解决方法把version改成2.6.（<a href="https://stackoverflow.com/questions/44363124/gradle-sync-failed-cause-org-gradle-listener-actionbroadcast）" target="_blank" rel="external">https://stackoverflow.com/questions/44363124/gradle-sync-failed-cause-org-gradle-listener-actionbroadcast）</a></p>
<p>5.butterknife报错解决</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Annotation processors must be explicitly declared now.  The following dependencies on the compile classpath are found to contain annotation processor.  Please add them to the annotationProcessor configuration.</div><div class="line">    - butterknife-<span class="number">7.0</span>.1.jar</div></pre></td></tr></table></figure>
<p>解决方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">    defaultConfig &#123;</div><div class="line">        ...</div><div class="line">        javaCompileOptions &#123;</div><div class="line">            annotationProcessorOptions &#123;</div><div class="line">                includeCompileClasspath = <span class="keyword">true</span>  </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2018/03/08/retrofit 上传文件/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/08/retrofit 上传文件/" itemprop="url">
                  retrofit 上传文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-08T15:31:06+08:00">
                2018-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/08/retrofit 上传文件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/03/08/retrofit 上传文件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="retrofit-上传文件"><a href="#retrofit-上传文件" class="headerlink" title="retrofit 上传文件"></a>retrofit 上传文件</h1><h2 id="单文件上传"><a href="#单文件上传" class="headerlink" title="单文件上传"></a>单文件上传</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Multipart</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"register"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">registerUser</span><span class="params">(@PartMultipartBody.Part photo,@Part(<span class="string">"username"</span>)</span> RequestBody username,@<span class="title">Part</span><span class="params">(<span class="string">"password"</span>)</span> RequestBody password)</span>;</div><div class="line"></div><div class="line">File file = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory(), <span class="string">"icon.png"</span>); RequestBody photoRequestBody = RequestBody.create(MediaType.parse(<span class="string">"image/png"</span>), file); MultipartBody.Part photo = MultipartBody.Part.createFormData(<span class="string">"photos"</span>, <span class="string">"icon.png"</span>, photoRequestBody); Call&lt;User&gt; call = userBiz.registerUser(photo, RequestBody.create(<span class="keyword">null</span>, <span class="string">"abc"</span>), RequestBody.create(<span class="keyword">null</span>, <span class="string">"123"</span>));</div></pre></td></tr></table></figure>
<h2 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Multipart</span></div><div class="line"><span class="meta">@POST</span>(<span class="string">"register"</span>)</div><div class="line"><span class="function">Call&lt;User&gt; <span class="title">registerUser</span><span class="params">(@PartMapMap&lt;String, RequestBody&gt; params,@Part(<span class="string">"password"</span>)</span> RequestBody password)</span>;</div><div class="line"></div><div class="line"></div><div class="line">File file = <span class="keyword">new</span> File(Environment.getExternalStorageDirectory(), <span class="string">"messenger_01.png"</span>); RequestBody photo = RequestBody.create(MediaType.parse(<span class="string">"image/png"</span>, file); Map&lt;String,RequestBody&gt; photos = <span class="keyword">new</span> HashMap&lt;&gt;(); photos.put(<span class="string">"photos\"; filename=\"icon.png"</span>, photo); photos.put(<span class="string">"username"</span>, RequestBody.create(<span class="keyword">null</span>, <span class="string">"abc"</span>)); Call&lt;User&gt; call = userBiz.registerUser(photos, RequestBody.create(<span class="keyword">null</span>, <span class="string">"123"</span>));</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="lijionghui" />
          <p class="site-author-name" itemprop="name">lijionghui</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lijionghui</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lijionghui"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  

  

  

  

  


</body>
</html>
