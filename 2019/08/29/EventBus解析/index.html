<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="源码," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="EventBus源码解析EventBus是一个优秀的第三方事件事件总线处理框架，具体的可以到这里 [https://github.com/greenrobot/EventBus] 查看。
简单使用
(1)定义事件1public static class MessageEvent &amp;#123;&amp;#125;
(2)准备订阅者（指定主线程）
12@Subscribe(threadMode = Threa">
<meta property="og:type" content="article">
<meta property="og:title" content="EventBus源码解析">
<meta property="og:url" content="https://lijionghui.github.io/2019/08/29/EventBus解析/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="EventBus源码解析EventBus是一个优秀的第三方事件事件总线处理框架，具体的可以到这里 [https://github.com/greenrobot/EventBus] 查看。
简单使用
(1)定义事件1public static class MessageEvent &amp;#123;&amp;#125;
(2)准备订阅者（指定主线程）
12@Subscribe(threadMode = Threa">
<meta property="og:updated_time" content="2019-08-30T04:34:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="EventBus源码解析">
<meta name="twitter:description" content="EventBus源码解析EventBus是一个优秀的第三方事件事件总线处理框架，具体的可以到这里 [https://github.com/greenrobot/EventBus] 查看。
简单使用
(1)定义事件1public static class MessageEvent &amp;#123;&amp;#125;
(2)准备订阅者（指定主线程）
12@Subscribe(threadMode = Threa">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'lijionghui'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lijionghui.github.io/2019/08/29/EventBus解析/"/>





  <title> EventBus源码解析 | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lijionghui.github.io/2019/08/29/EventBus解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lijionghui">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                EventBus源码解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-29T11:17:26+08:00">
                2019-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/29/EventBus解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/08/29/EventBus解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="EventBus源码解析"><a href="#EventBus源码解析" class="headerlink" title="EventBus源码解析"></a>EventBus源码解析</h1><p>EventBus是一个优秀的第三方事件事件总线处理框架，具体的可以到这里 [<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">https://github.com/greenrobot/EventBus</a>] 查看。</p>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><hr>
<p>(1)定义事件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>(2)准备订阅者（指定主线程）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessageEvent</span><span class="params">(MessageEvent event)</span> </span>&#123;&#125;;</div></pre></td></tr></table></figure>
<p>(3)订阅者注册，解除注册 </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStart();</div><div class="line">    EventBus.getDefault().register(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onStop();</div><div class="line">    EventBus.getDefault().unregister(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> (4)发送事件</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.getDefault().post(<span class="keyword">new</span> MessageEvent());</div></pre></td></tr></table></figure>
<hr>
<h2 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h2><hr>
<ol>
<li>EventBus.getDefault()；//获取实例</li>
<li>EventBus.getDefault().register(this); //注册</li>
<li>EventBus.getDefault().unregister(this); //解注册</li>
<li>EventBus.getDefault().post(Object object); //发送普通事件</li>
<li>EventBus.getDefault().postSticky(Object object); //发送粘性事件</li>
</ol>
<hr>
<h3 id="EventBus-getDefault"><a href="#EventBus-getDefault" class="headerlink" title="EventBus.getDefault()"></a>EventBus.getDefault()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//使用双重检查锁模式获取单例</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">               <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                   defaultInstance = <span class="keyword">new</span> EventBus();<span class="number">1</span>.初始化</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> defaultInstance;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">分析<span class="number">1</span>：初始化</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(DEFAULT_BUILDER);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">  <span class="comment">//为EventBus里的各个变量赋值</span></div><div class="line">  EventBus(EventBusBuilder builder) &#123;</div><div class="line">       logger = builder.getLogger();  <span class="comment">//logger打印</span></div><div class="line">       subscriptionsByEventType = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">//以事件类型为key的map</span></div><div class="line">       typesBySubscriber = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">//以订阅者为key的map</span></div><div class="line">       stickyEvents = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); <span class="comment">//粘性事件的map</span></div><div class="line">       </div><div class="line">       <span class="comment">//主线程相关的初始化操作</span></div><div class="line">       mainThreadSupport = builder.getMainThreadSupport();</div><div class="line">       mainThreadPoster = mainThreadSupport != <span class="keyword">null</span> ? mainThreadSupport.createPoster(<span class="keyword">this</span>) : <span class="keyword">null</span>;</div><div class="line">       </div><div class="line">        <span class="comment">//后台线程相关的初始化操作</span></div><div class="line">       backgroundPoster = <span class="keyword">new</span> BackgroundPoster(<span class="keyword">this</span>);</div><div class="line">       </div><div class="line">       <span class="comment">//异步线程相关的初始化操作</span></div><div class="line">       asyncPoster = <span class="keyword">new</span> AsyncPoster(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">//得到订阅信息的数量</span></div><div class="line">       indexCount = builder.subscriberInfoIndexes != <span class="keyword">null</span> ? builder.subscriberInfoIndexes.size() : <span class="number">0</span>;</div><div class="line">       <span class="comment">//订阅方法查找类</span></div><div class="line">       subscriberMethodFinder = <span class="keyword">new</span> SubscriberMethodFinder(builder.subscriberInfoIndexes,</div><div class="line">               builder.strictMethodVerification, builder.ignoreGeneratedIndex);</div><div class="line">       logSubscriberExceptions = builder.logSubscriberExceptions;</div><div class="line">       logNoSubscriberMessages = builder.logNoSubscriberMessages;</div><div class="line">       <span class="comment">//订阅者发送事件异常</span></div><div class="line">       sendSubscriberExceptionEvent = builder.sendSubscriberExceptionEvent;</div><div class="line">       <span class="comment">//订阅者没有发送事件</span></div><div class="line">       sendNoSubscriberEvent = builder.sendNoSubscriberEvent;</div><div class="line">       <span class="comment">//异常</span></div><div class="line">       throwSubscriberException = builder.throwSubscriberException;</div><div class="line">       eventInheritance = builder.eventInheritance;</div><div class="line">       <span class="comment">//线程池</span></div><div class="line">       executorService = builder.executorService;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面完成了EventBus实例的基本配置</p>
<h3 id="EventBus-getDefault-register-this-注册"><a href="#EventBus-getDefault-register-this-注册" class="headerlink" title="EventBus.getDefault().register(this) 注册"></a>EventBus.getDefault().register(this) 注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">       Class&lt;?&gt; subscriberClass = subscriber.getClass();</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass); <span class="comment">//1.查找订阅者中的所有订阅方法</span></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">               subscribe(subscriber, subscriberMethod); <span class="comment">//2.进行具体订阅操作</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"> <span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);  <span class="comment">//查找缓存如果缓存中有则直接返回</span></div><div class="line">       <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">           subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                   + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">//将查找到的结果放入缓存中            </span></div><div class="line">       METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>我们看下SubscriberMethod到底包含哪些东西</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SubscriberMethod</span><span class="params">(Method method, Class&lt;?&gt; eventType, ThreadMode threadMode, <span class="keyword">int</span> priority, <span class="keyword">boolean</span> sticky)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.method = method; <span class="comment">//方法</span></div><div class="line">    <span class="keyword">this</span>.threadMode = threadMode; <span class="comment">//线程</span></div><div class="line">    <span class="keyword">this</span>.eventType = eventType; <span class="comment">//事件类型</span></div><div class="line">    <span class="keyword">this</span>.priority = priority;  <span class="comment">//优先级</span></div><div class="line">    <span class="keyword">this</span>.sticky = sticky;  <span class="comment">//时候是粘性事件</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那是在哪里初始化的，是在SubscriberMethodFinder，AbstractSubscriberInfo中，这两个对应两种不同的查找方式，在上面我们发现EventBus会通过判断ignoreGeneratedIndex的值来调用不同的查找方法（1）findUsingReflection(subscriberClass);（2）findUsingInfo(subscriberClass)，ignoreGeneratedIndex的值可以通过EventBusBuilder来修改，默认情况下ignoreGeneratedIndex为false<br>，所以我们主要来分析一下findUsingInfo(subscriberClass)方法：</p>
<h4 id="findUsingInfo-subscriberClass"><a href="#findUsingInfo-subscriberClass" class="headerlink" title="findUsingInfo(subscriberClass)"></a>findUsingInfo(subscriberClass)</h4><p>首页看一下FindState这个类，它是SubscriberMethodFinder的内部类，主要包含订阅者和订阅方法信息变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FindState</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> Map&lt;Class, Object&gt; anyMethodByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> Map&lt;String, Class&gt; subscriberClassByMethodKey = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> StringBuilder methodKeyBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</div><div class="line"></div><div class="line">        Class&lt;?&gt; subscriberClass;</div><div class="line">        Class&lt;?&gt; clazz;</div><div class="line">        <span class="keyword">boolean</span> skipSuperClasses;</div><div class="line">        SubscriberInfo subscriberInfo;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       FindState findState = prepareFindState(); <span class="comment">//返回FindState对象</span></div><div class="line">       findState.initForSubscriber(subscriberClass);<span class="comment">//初始化一些订阅者信息</span></div><div class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123; <span class="comment">//进入循环</span></div><div class="line">           findState.subscriberInfo = getSubscriberInfo(findState);</div><div class="line">           <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123; <span class="comment">////获取订阅者信息，没有配置MyEventBusIndex返回null</span></div><div class="line">               SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</div><div class="line">               <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</div><div class="line">                   <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</div><div class="line">                       findState.subscriberMethods.add(subscriberMethod);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//通过反射查找订阅方法</span></div><div class="line">               findUsingReflectionInSingleClass(findState);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//进入父类查找订阅方法</span></div><div class="line">           findState.moveToSuperclass();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//获取方法并进行释放</span></div><div class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面代码首先会常见一个FindState类用来保存订阅者的方法和其他信息，然后通过循环查找当前类和分类的订阅方法，最后会返回所有获取到的方法并进行释放。一般情况下findState.subscriberInfo 都是为null,所以最后我们具体是通过反射findUsingReflectionInSingleClass(findState)来查找具体的方法。</p>
<h4 id="findUsingReflectionInSingleClass-findState"><a href="#findUsingReflectionInSingleClass-findState" class="headerlink" title="findUsingReflectionInSingleClass(findState)"></a>findUsingReflectionInSingleClass(findState)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">       Method[] methods;</div><div class="line">       <span class="comment">//通过反射拿到该订阅者的所有方法</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">           methods = findState.clazz.getDeclaredMethods();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">           <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></div><div class="line">           methods = findState.clazz.getMethods();</div><div class="line">           findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//遍历所有方法，取出符合条件的方法</span></div><div class="line">       <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">           <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">           <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 获得当前方法所有参数的类型</span></div><div class="line">               Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">               <span class="comment">//保证只有一个参数</span></div><div class="line">               <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">               <span class="comment">//找到用Subscribe注解的方法</span></div><div class="line">                   Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                   <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// 得到该参数的类型</span></div><div class="line">                       Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                       </div><div class="line">                       <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                       <span class="comment">//得到线程</span></div><div class="line">                           ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                             <span class="comment">//实例化一个SubscriberMethod对象并添加到 findState.subscriberMethods中</span></div><div class="line">                           findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                   subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                   String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                           <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">               String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                       <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上面代码中会先经过反射得到某个订阅者所有的方法，通过for循环找到EventBus注解的方法，再通过findState.checkAdd方法检验，最终会新建一个SubscriberMethod对象，并将该对象添加到findState.subscriberMethods的集合中，我们最终就能通过getMethodsAndRelease(findState)方法获取到所有订阅方法的集合。现在可以通过得到的subscriberMethods，进行真正的订阅。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// Must be called in synchronized block</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</div><div class="line">        <span class="comment">//获取到方法的事件类型</span></div><div class="line">        Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">         <span class="comment">//构造一个Subscription对象由订阅者和该订阅方法组成</span></div><div class="line">        Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</div><div class="line">        / subscriptionsByEventType是一个HashMap，保存了以eventType为key,Subscription对象集合为value的键值对</div><div class="line">        <span class="comment">// 先查找subscriptionsByEventType是否存在以当前eventType为key的值        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span></div><div class="line">        <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果不存在，则创建一个subscriptions，并保存到subscriptionsByEventType</span></div><div class="line">            subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></div><div class="line">                        + eventType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">             <span class="comment">// 添加上边创建的newSubscription对象到subscriptions中</span></div><div class="line">                subscriptions.add(i, newSubscription);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="comment">// typesBySubscriber也是一个HashMap，保存了以当前要注册类的对象为key，注册类中订阅事件的方法的参数类型的集合为value的键值对</span></div><div class="line">        <span class="comment">// 查找是否存在对应的参数类型集合</span></div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">        <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 不存在则创建一个subscribedEvents，并保存到typesBySubscriber</span></div><div class="line">            subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">        &#125;</div><div class="line">        /添加事件到 subscribedEvents集合中</div><div class="line">        subscribedEvents.add(eventType);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (subscriberMethod.sticky) &#123;<span class="comment">//如果是粘性事件</span></div><div class="line">            <span class="comment">// stickyEvents就是发送粘性事件时，保存了事件类型和对应事件</span></div><div class="line">            <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">                Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">                <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                    Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                    <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                        Object stickyEvent = entry.getValue();</div><div class="line">                        <span class="comment">// 处理粘性事件checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">                checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到这整个注册流程就梳理完了，这里总结一下：</p>
<ol>
<li>注册首先会通过SubscriberMethodFinder这个类来找到某个订阅者所有的订阅方法。</li>
<li>通过对得到的订阅方法遍历进行订阅。</li>
<li>订阅方法中用subscriptionsByEventType保存了以EventType为key,subscriptions为value的键值对。</li>
<li>typesBySubscriber保存以Subscriber为key，EventType集合为value的键值对</li>
<li>在有粘性事件的情况下会发送粘性消息进行处理</li>
</ol>
<h3 id="EventBus-getDefault-unregister-this-解注册"><a href="#EventBus-getDefault-unregister-this-解注册" class="headerlink" title="EventBus.getDefault().unregister(this); 解注册"></a>EventBus.getDefault().unregister(this); 解注册</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber); (<span class="number">1</span>)</div><div class="line">        <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;<span class="comment">//分析1</span></div><div class="line">                unsubscribeByEventType(subscriber, eventType);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 删除以subscriber为key的键值对            typesBySubscriber.remove(subscriber);</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            logger.log(Level.WARNING, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//分析1 </span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">        List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">                Subscription subscription = subscriptions.get(i);</div><div class="line">                 <span class="comment">// 如果当前subscription对象对应的注册类对象和要取消注册的注册类对象相同，则删除当前subscription对象</span></div><div class="line">                <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</div><div class="line">                    subscription.active = <span class="keyword">false</span>;</div><div class="line">                    subscriptions.remove(i);</div><div class="line">                    i--;</div><div class="line">                    size--;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先在typesBySubscriber集合中查找除所有以当前subscriber为hey的subscribedTypes集合，对subscribedTypes进行遍历。</li>
<li>调用unsubscribeByEventType找到subscriptionsByEventType以某个eventType为key的subscriptions集合，对subscriptions集合遍历得到subscription对象，如果当前subscription对象对应的注册类对象和要取消注册的注册类对象相同，则删除当前subscription对象。</li>
<li>typesBySubscriber的集合中删除以该subscriber为key的键值对    </li>
</ol>
<h3 id="EventBus-getDefault-post-Object-object-发送普通事件"><a href="#EventBus-getDefault-post-Object-object-发送普通事件" class="headerlink" title="EventBus.getDefault().post(Object object); //发送普通事件"></a>EventBus.getDefault().post(Object object); //发送普通事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line"> </div><div class="line">  <span class="comment">//currentPostingThreadState是一个PostingThreadState类型的ThreadLocal</span></div><div class="line">       <span class="comment">// PostingThreadState类保存了事件队列和线程模式等信息</span></div><div class="line">        PostingThreadState postingState = currentPostingThreadState.get();</div><div class="line">        List&lt;Object&gt; eventQueue = postingState.eventQueue;</div><div class="line">         <span class="comment">// 将要发送的事件添加到事件队列</span></div><div class="line">        eventQueue.add(event);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!postingState.isPosting) &#123;</div><div class="line">            postingState.isMainThread = isMainThread();</div><div class="line">            postingState.isPosting = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (postingState.canceled) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123; <span class="comment">//队列不为空发送消息，并移除</span></div><div class="line">                    postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState); <span class="comment">//分析1</span></div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                postingState.isPosting = <span class="keyword">false</span>;</div><div class="line">                postingState.isMainThread = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"></div><div class="line"><span class="comment">//分析1 循环发送单个事件</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</div><div class="line">        Class&lt;?&gt; eventClass = event.getClass();</div><div class="line">        <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// eventInheritance默认为true，表示是否向上查找事件的父类</span></div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">            List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</div><div class="line">            <span class="keyword">int</span> countTypes = eventTypes.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</div><div class="line">                Class&lt;?&gt; clazz = eventTypes.get(h);</div><div class="line">                subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</div><div class="line">        &#125;</div><div class="line">         <span class="comment">//找不到事件异常处理</span></div><div class="line">        <span class="keyword">if</span> (!subscriptionFound) &#123;</div><div class="line">            <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</div><div class="line">                logger.log(Level.FINE, <span class="string">"No subscribers registered for event "</span> + eventClass);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</div><div class="line">                    eventClass != SubscriberExceptionEvent.class) &#123;</div><div class="line">                post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));<span class="comment">//发送没有订阅消息</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后会调用postSingleEventForEventType()方法进一步处理事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// 获取事件类型对应的Subscription集合</span></div><div class="line">            subscriptions = subscriptionsByEventType.get(eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</div><div class="line">        <span class="comment">//遍历subscriptions集合，给postingState.event赋值</span></div><div class="line">            <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</div><div class="line">                postingState.event = event;</div><div class="line">                postingState.subscription = subscription;</div><div class="line">                <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//真正的事件处理</span></div><div class="line">                    postToSubscription(subscription, event, postingState.isMainThread);</div><div class="line">                    aborted = postingState.canceled;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                 <span class="comment">//将postingState置为初始状态</span></div><div class="line">                    postingState.event = <span class="keyword">null</span>;</div><div class="line">                    postingState.subscription = <span class="keyword">null</span>;</div><div class="line">                    postingState.canceled = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (aborted) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到这里才看到最终真正处理事件的方法 postToSubscription(subscription, event, postingState.isMainThread);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">            <span class="keyword">case</span> POSTING: <span class="comment">// 默认的线程模式，在那个线程发送事件就在那个线程处理事件</span></div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MAIN: <span class="comment">//主线程</span></div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                  <span class="comment">// 如果在主线程发送事件，则直接在主线程通过反射处理事件</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果是在子线程发送事件，则将事件入队列，通过Handler切换到主线程执行处理事件</span></div><div class="line">                    mainThreadPoster.enqueue(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MAIN_ORDERED:</div><div class="line">                <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// 无论在那个线程发送事件，都先将事件入队列，然后通过 Handler 切换到主线程，依次处理事件。</span></div><div class="line">                    mainThreadPoster.enqueue(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BACKGROUND: </div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                 <span class="comment">// 如果在主线程发送事件，则先将事件入队列，然后通过线程池依次处理事件</span></div><div class="line">                    backgroundPoster.enqueue(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 如果在子线程发送事件，则直接在发送事件的线程通过反射处理事件</span></div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ASYNC:  <span class="comment">// 无论在那个线程发送事件，都将事件入队列，然后通过线程池处理。</span></div><div class="line">                asyncPoster.enqueue(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在使用Subscribe注解的时候是可以指定线程的</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMessage</span><span class="params">(MessageEvent messageEvent)</span> </span>&#123;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>postToSubscription中的case条件就是threadMode指定的线程，根据不同的线程进行不同的处理。还记得EventBus.getDefault()的初始化方法吗，mainThreadPoster，backgroundPoster，asyncPoster就是在EventBus.getDefault()的赋值的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Poster</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">    AsyncPoster(EventBus eventBus) &#123;</div><div class="line">        <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">        queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">        queue.enqueue(pendingPost);</div><div class="line">        eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        PendingPost pendingPost = queue.poll();</div><div class="line">        <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</div><div class="line">        &#125;</div><div class="line">        eventBus.invokeSubscriber(pendingPost);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到AsyncPoster通过enqueue方法，事件先入队，然后PendingPost pendingPost = queue.poll();的轮询获取 pendingPost，最后通过 eventBus.invokeSubscriber(pendingPost);其他两个poster最终也会调用eventBus.invokeSubscriber(pendingPost)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> </span>&#123;</div><div class="line">        Object event = pendingPost.event;</div><div class="line">        Subscription subscription = pendingPost.subscription;</div><div class="line">        PendingPost.releasePendingPost(pendingPost);</div><div class="line">        <span class="keyword">if</span> (subscription.active) &#123;</div><div class="line">            invokeSubscriber(subscription, event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>invokeSubscriber(pendingPost)最后还是调用了invokeSubscriber(subscription, event)方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</div><div class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">           handleSubscriberException(subscription, event, e.getCause());</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到最后是通过反射发送事件的。</p>
<h3 id="EventBus-getDefault-postSticky-Object-object-发送粘性事件"><a href="#EventBus-getDefault-postSticky-Object-object-发送粘性事件" class="headerlink" title="EventBus.getDefault(). postSticky(Object object); //发送粘性事件"></a>EventBus.getDefault(). postSticky(Object object); //发送粘性事件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">     <span class="keyword">synchronized</span> (stickyEvents) &#123;</div><div class="line">         stickyEvents.put(event.getClass(), event);</div><div class="line">     &#125;</div><div class="line">     post(event);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>postSticky()方法主要做了两件事，先将事件类型和对应事件保存到stickyEvents中，方便在注册时如果是粘性事件则取出来直接发送处理；然后执行post(event)继续发送事件，这个post()方法就是之前发送普通消息的post()方法。所以，如果在发送粘性事件前，已经有了对应类型事件的订阅者，不是非粘性的，依然可以接收到发送出的粘性事件。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/28/ThreadLocal解析/" rel="next" title="ThreadLocal解析">
                <i class="fa fa-chevron-left"></i> ThreadLocal解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/30/线程池/" rel="prev" title="线程池使用">
                线程池使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2019/08/29/EventBus解析/"
           data-title="EventBus源码解析" data-url="https://lijionghui.github.io/2019/08/29/EventBus解析/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="lijionghui" />
          <p class="site-author-name" itemprop="name">lijionghui</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#EventBus源码解析"><span class="nav-number">1.</span> <span class="nav-text">EventBus源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单使用"><span class="nav-number">1.1.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体分析"><span class="nav-number">1.2.</span> <span class="nav-text">具体分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-getDefault"><span class="nav-number">1.2.1.</span> <span class="nav-text">EventBus.getDefault()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-getDefault-register-this-注册"><span class="nav-number">1.2.2.</span> <span class="nav-text">EventBus.getDefault().register(this) 注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#findUsingInfo-subscriberClass"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">findUsingInfo(subscriberClass)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findUsingReflectionInSingleClass-findState"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">findUsingReflectionInSingleClass(findState)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-getDefault-unregister-this-解注册"><span class="nav-number">1.2.3.</span> <span class="nav-text">EventBus.getDefault().unregister(this); 解注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-getDefault-post-Object-object-发送普通事件"><span class="nav-number">1.2.4.</span> <span class="nav-text">EventBus.getDefault().post(Object object); //发送普通事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EventBus-getDefault-postSticky-Object-object-发送粘性事件"><span class="nav-number">1.2.5.</span> <span class="nav-text">EventBus.getDefault(). postSticky(Object object); //发送粘性事件</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lijionghui</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lijionghui"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  

  

  

  

  


</body>
</html>
